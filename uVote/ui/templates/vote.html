{% extends "base.html" %}
{% block content %}
<div id="colorlib-main">
	<section class="ftco-section pt-4 mb-5 ftco-intro">
		<div class="container-fluid px-3 px-md-0">
			<div class="row">
				<div class="col-md-12 mb-4">
					<h1 class="h2">Voting System</h1>
				</div>
				<div id="wallet-address-display"></div>
				<div class="col-md-12 mb-2">
					<button type="button" class="btn btn-primary" id="connect-wallet-button">Connect Wallet</button>
				</div>
				<div class="col-md-12 mb-2">
					<button type="button" class="btn btn-primary" id="create-ballot-button">Create Ballot</button>
				</div>
				<div class="col-md-12 mb-2">
					<button type="button" class="btn btn-primary" id="cast-vote-button">Cast Vote</button>
				</div>
				<div class="col-md-12 mb-2">
					<button type="button" class="btn btn-primary" id="check-voting-open-button">Check If Voting
						Open</button>
				</div>
				<div class="col-md-12 mb-2">
					<button type="button" class="btn btn-primary" id="get-max-choices-button">Get Max Choices</button>
				</div>
				<div class="col-md-12 mb-2">
					<button type="button" class="btn btn-primary" id="check-if-voted-button">Check If Voted</button>
				</div>
				<div class="col-md-12 mb-2">
					<button type="button" class="btn btn-primary" id="tally-votes-button">Tally Votes</button>
				</div>

				<div id="create-ballot-modal" class="modal fade" tabindex="-1" role="dialog">
					<div class="modal-dialog" role="document">
						<div class="modal-content">
							<div class="modal-header">
								<h5 class="modal-title">Create New Ballot</h5>
								<button type="button" class="close" data-dismiss="modal" aria-label="Close">
									<span aria-hidden="true">&times;</span>
								</button>
							</div>
							<div class="modal-body">
								<form id="create-vote-form">
									{% csrf_token %}
									<div class="form-group">
										<label for="wallet-address">Wallet Address:</label>
										<input type="text" class="form-control" id="wallet-address"
											name="wallet-address" readonly>
									</div>
									<div class="form-group">
										<label for="vote-title">Vote Title:</label>
										<input type="text" class="form-control" id="vote-title" name="vote-title"
											required>
									</div>
									<div class="form-group">
										<label for="max-choices">Max Choices:</label>
										<input type="number" class="form-control" id="max-choices" name="max-choices"
											required>
									</div>
									<div id="options-container">
									</div>
									<button type="submit" class="btn btn-primary">Create Vote</button>
								</form>
							</div>
							<div class="modal-footer">
								<button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
							</div>
						</div>
					</div>
				</div>
				<div id="cast-vote-modal" class="modal fade" tabindex="-1" role="dialog">
					<div class="modal-dialog" role="document">
						<div class="modal-content">
							<div class="modal-header">
								<h5 class="modal-title">Cast a Vote</h5>
								<button type="button" class="close" data-dismiss="modal" aria-label="Close">
									<span aria-hidden="true">&times;</span>
								</button>
							</div>
							<div class="modal-body">
								<form id="cast-vote-form">
									<div class="form-group">
										<label for="cast-vote-id-modal">Vote ID:</label>
										<input type="number" class="form-control" id="cast-vote-id-modal" required>
									</div>
									<div class="form-group">
										<label for="cast-vote-options-modal">Options (comma-separated):</label>
										<input type="text" class="form-control" id="cast-vote-options-modal" required>
									</div>
									<button type="submit" class="btn btn-primary">Submit Vote</button>
								</form>
							</div>
							<div class="modal-footer">
								<button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
							</div>
						</div>
					</div>
				</div>
				<div id="check-voting-open-modal" class="modal fade" tabindex="-1" role="dialog">
					<div class="modal-dialog" role="document">
						<div class="modal-content">
							<div class="modal-header">
								<h5 class="modal-title">Check If Voting Is Open</h5>
								<button type="button" class="close" data-dismiss="modal" aria-label="Close">
									<span aria-hidden="true">&times;</span>
								</button>
							</div>
							<div class="modal-body">
								<form id="check-voting-open-form">
									<div class="form-group">
										<label for="check-voting-open-id-modal">Vote ID:</label>
										<input type="number" class="form-control" id="check-voting-open-id-modal"
											required>
									</div>
									<button type="submit" class="btn btn-primary">Check Voting Status</button>
								</form>
							</div>
							<div class="modal-footer">
								<button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
							</div>
						</div>
					</div>
				</div>
				<div id="get-max-choices-modal" class="modal fade" tabindex="-1" role="dialog">
					<div class="modal-dialog" role="document">
						<div class="modal-content">
							<div class="modal-header">
								<h5 class="modal-title">Get Maximum Choices</h5>
								<button type="button" class="close" data-dismiss="modal" aria-label="Close">
									<span aria-hidden="true">&times;</span>
								</button>
							</div>
							<div class="modal-body">
								<form id="get-max-choices-form">
									<div class="form-group">
										<label for="get-max-choices-id-modal">Vote ID:</label>
										<input type="number" class="form-control" id="get-max-choices-id-modal"
											required>
									</div>
									<button type="submit" class="btn btn-primary">Get Choices</button>
								</form>
							</div>
							<div class="modal-footer">
								<button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
							</div>
						</div>
					</div>
				</div>
				<div id="check-if-voted-modal" class="modal fade" tabindex="-1" role="dialog">
					<div class="modal-dialog" role="document">
						<div class="modal-content">
							<div class="modal-header">
								<h5 class="modal-title">Check If Voted</h5>
								<button type="button" class="close" data-dismiss="modal" aria-label="Close">
									<span aria-hidden="true">&times;</span>
								</button>
							</div>
							<div class="modal-body">
								<form id="check-if-voted-form">
									<div class="form-group">
										<label for="check-if-voted-id-modal">Vote ID:</label>
										<input type="number" class="form-control" id="check-if-voted-id-modal" required>
									</div>
									<div class="form-group">
										<label for="check-if-voted-address-modal">Voter Address:</label>
										<input type="text" class="form-control" id="check-if-voted-address-modal"
											required>
									</div>
									<button type="submit" class="btn btn-primary">Check Voter Status</button>
								</form>
							</div>
							<div class="modal-footer">
								<button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
							</div>
						</div>
					</div>
				</div>
				<div id="tally-votes-modal" class="modal fade" tabindex="-1" role="dialog">
					<div class="modal-dialog" role="document">
						<div class="modal-content">
							<div class="modal-header">
								<h5 class="modal-title">Tally Votes</h5>
								<button type="button" class="close" data-dismiss="modal" aria-label="Close">
									<span aria-hidden="true">&times;</span>
								</button>
							</div>
							<div class="modal-body">
								<form id="tally-votes-form">
									<div class="form-group">
										<label for="tally-votes-id-modal">Vote ID:</label>
										<input type="number" class="form-control" id="tally-votes-id-modal" required>
									</div>
									<button type="submit" class="btn btn-primary">Tally Votes</button>
								</form>
							</div>
							<div class="modal-footer">
								<button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
							</div>
						</div>
					</div>
				</div>
				<div id="view-results-modal" class="modal fade" tabindex="-1" role="dialog">
					<div class="modal-dialog" role="document">
						<div class="modal-content">
							<div class="modal-header">
								<h5 class="modal-title">View Results</h5>
								<button type="button" class="close" data-dismiss="modal" aria-label="Close">
									<span aria-hidden="true">&times;</span>
								</button>
							</div>
							<div class="modal-body">
								<form id="view-results-form">
									<div class="form-group">
										<label for="view-results-id-modal">Vote ID:</label>
										<input type="number" class="form-control" id="view-results-id-modal" required>
									</div>
									<button type="submit" class="btn btn-primary">View Results</button>
								</form>
								<!-- Place to display the results -->
								<div id="vote-results-container"></div>
							</div>
							<div class="modal-footer">
								<button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
							</div>
						</div>
					</div>
				</div>


				<div class="col-md-12" id="votes-container">
					<!-- Active votes will be displayed here -->
				</div>
			</div>
		</div>
	</section>
</div>

<script src="https://cdn.jsdelivr.net/npm/web3@1.3.0/dist/web3.min.js"></script>

<script>
	let web3;
	let walletAddress = null;
	let uVoteContract;
	function getInputValue(elementId) {
		return document.getElementById(elementId).value;
	}
	async function initContract() {
		const contractABI = [
			{
				"anonymous": false,
				"inputs": [
					{
						"indexed": false,
						"internalType": "uint256",
						"name": "ballotId",
						"type": "uint256"
					},
					{
						"indexed": false,
						"internalType": "uint256[]",
						"name": "optionCounts",
						"type": "uint256[]"
					}
				],
				"name": "VoteEnded",
				"type": "event"
			},
			{
				"anonymous": false,
				"inputs": [
					{
						"indexed": false,
						"internalType": "uint256",
						"name": "ballotId",
						"type": "uint256"
					}
				],
				"name": "VoteStarted",
				"type": "event"
			},
			{
				"anonymous": false,
				"inputs": [
					{
						"indexed": true,
						"internalType": "address",
						"name": "voter",
						"type": "address"
					},
					{
						"indexed": false,
						"internalType": "uint256",
						"name": "ballotId",
						"type": "uint256"
					},
					{
						"indexed": false,
						"internalType": "uint256[]",
						"name": "selectedOptions",
						"type": "uint256[]"
					}
				],
				"name": "Voted",
				"type": "event"
			},
			{
				"inputs": [
					{
						"internalType": "uint256",
						"name": "ballotId",
						"type": "uint256"
					},
					{
						"internalType": "uint256[]",
						"name": "selectedOptions",
						"type": "uint256[]"
					}
				],
				"name": "castVote",
				"outputs": [],
				"stateMutability": "nonpayable",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "uint256",
						"name": "ballotId",
						"type": "uint256"
					}
				],
				"name": "getMaxChoices",
				"outputs": [
					{
						"internalType": "uint256",
						"name": "",
						"type": "uint256"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "uint256",
						"name": "ballotId",
						"type": "uint256"
					},
					{
						"internalType": "uint256",
						"name": "option",
						"type": "uint256"
					}
				],
				"name": "getOptionCount",
				"outputs": [
					{
						"internalType": "uint256",
						"name": "",
						"type": "uint256"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "uint256",
						"name": "ballotId",
						"type": "uint256"
					},
					{
						"internalType": "address",
						"name": "voter",
						"type": "address"
					}
				],
				"name": "hasVoted",
				"outputs": [
					{
						"internalType": "bool",
						"name": "",
						"type": "bool"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "uint256",
						"name": "ballotId",
						"type": "uint256"
					}
				],
				"name": "isVotingOpen",
				"outputs": [
					{
						"internalType": "bool",
						"name": "",
						"type": "bool"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [],
				"name": "nextBallotId",
				"outputs": [
					{
						"internalType": "uint256",
						"name": "",
						"type": "uint256"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "uint256[]",
						"name": "_options",
						"type": "uint256[]"
					},
					{
						"internalType": "uint256",
						"name": "_maxChoices",
						"type": "uint256"
					}
				],
				"name": "startVote",
				"outputs": [],
				"stateMutability": "nonpayable",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "uint256",
						"name": "ballotId",
						"type": "uint256"
					}
				],
				"name": "tallyVotes",
				"outputs": [],
				"stateMutability": "nonpayable",
				"type": "function"
			}
		];
		const contractAddress = '0x2161d2F4Efd8A58682d91e91409E8d231e9307ef';
		uVoteContract = new web3.eth.Contract(contractABI, contractAddress);
		displayActiveVotes();
	}

	async function initWeb3() {
		if (typeof window.ethereum !== 'undefined') {
			web3 = new Web3(window.ethereum);
			try {
				await window.ethereum.request({ method: 'eth_requestAccounts' });
				const accounts = await web3.eth.getAccounts();
				walletAddress = accounts[0];
				await initContract();

				document.getElementById('wallet-address').value = walletAddress;
				document.getElementById('wallet-address-display').innerText = `Wallet Address: ${walletAddress}`;
			} catch (error) {
				console.error('Error connecting to MetaMask:', error);
			}
		} else {
			console.error('MetaMask is not available...');
		}
	}

	document.getElementById('connect-wallet-button').addEventListener('click', initWeb3);

	document.getElementById('max-choices').addEventListener('input', function (event) {
		const maxChoices = parseInt(event.target.value, 10);
		const optionsContainer = document.getElementById('options-container');
		optionsContainer.innerHTML = ''; // Clear existing fields

		for (let i = 1; i <= maxChoices; i++) {
			// Create input field for option number
			const numberInputField = document.createElement('input');
			numberInputField.type = 'number';
			numberInputField.className = 'form-control mb-1';
			numberInputField.id = `option-number-${i}`;
			numberInputField.name = `option-number-${i}`;
			numberInputField.placeholder = `Option Number ${i}`;
			numberInputField.value = i; // Set option number
			numberInputField.readOnly = true; // Make it read-only

			// Create input field for option name
			const nameInputField = document.createElement('input');
			nameInputField.type = 'text';
			nameInputField.className = 'form-control mb-2';
			nameInputField.id = `option-name-${i}`;
			nameInputField.name = `option-name-${i}`;
			nameInputField.placeholder = `Option Name ${i}`;

			optionsContainer.appendChild(numberInputField);
			optionsContainer.appendChild(nameInputField);
		}
	});


	function extractVoteIdFromReceipt(receipt) {
		// Look for the 'VoteStarted' event in the transaction receipt
		const voteStartedEvent = receipt.events ? receipt.events.VoteStarted : null;
		if (voteStartedEvent) {
			// Assuming 'ballotId' is the first argument in the event
			return voteStartedEvent.returnValues.ballotId;
		} else {
			console.error('VoteStarted event not found in receipt');
			return null; // or handle this case as needed
		}
	}

	// Event listener to open the Cast Vote modal
	document.getElementById('cast-vote-button').addEventListener('click', function () {
		$('#cast-vote-modal').modal('show');
	});
	document.getElementById('create-ballot-button').addEventListener('click', function () {
		$('#create-ballot-modal').modal('show');
	});
	document.getElementById('check-voting-open-button').addEventListener('click', function () {
		$('#check-voting-open-modal').modal('show');
	});
	document.getElementById('get-max-choices-button').addEventListener('click', function () {
		$('#get-max-choices-modal').modal('show');
	});
	document.getElementById('check-if-voted-button').addEventListener('click', function () {
		$('#check-if-voted-modal').modal('show');
	});
	document.getElementById('tally-votes-button').addEventListener('click', function () {
		$('#tally-votes-modal').modal('show');
	});
	document.getElementById('view-results-form').addEventListener('click', function () {
		$('view-results-id-modal').modal('show');
	});

	// Handling the submission of the Cast Vote form
	document.getElementById('cast-vote-form').addEventListener('submit', async function (event) {
		event.preventDefault();
		const ballotId = parseInt(document.getElementById('cast-vote-id-modal').value, 10);
		const selectedOptions = document.getElementById('cast-vote-options-modal').value.split(',').map(Number);

		try {
			const transaction = await uVoteContract.methods.castVote(ballotId, selectedOptions).send({ from: walletAddress });
			console.log('Vote cast successfully:', transaction);
			$('#cast-vote-modal').modal('hide'); // Close the modal after successful transaction
		} catch (error) {
			console.error('Error casting vote:', error);
		}
	});


	document.getElementById('create-vote-form').addEventListener('submit', async function (event) {
		event.preventDefault();
		if (!walletAddress) {
			console.error('Wallet address not available. Please connect your wallet.');
			return;
		}

		const maxChoices = parseInt(document.getElementById('max-choices').value, 10);
		const optionsData = [];
		for (let i = 1; i <= maxChoices; i++) {
			optionsData.push({
				number: i,
				name: document.getElementById(`option-name-${i}`).value
			});
		}

		const optionNumbers = optionsData.map(option => option.number);

		try {
			const transaction = await uVoteContract.methods.startVote(optionNumbers, maxChoices).send({ from: walletAddress });
			// Additional transaction handling...
			$('#create-ballot-modal').modal('hide');
		} catch (error) {
			console.error('Error:', error);
		}
	});
	document.getElementById('tally-votes-form').addEventListener('submit', async function (event) {
		event.preventDefault();
		const ballotId = parseInt(document.getElementById('tally-votes-id-modal').value, 10);

		try {
			const transaction = await uVoteContract.methods.tallyVotes(ballotId).send({ from: walletAddress });
			console.log('Votes tallied successfully:', transaction);
			$('#tally-votes-modal').modal('hide');
		} catch (error) {
			console.error('Error tallying votes:', error);
		}
	});
	document.getElementById('view-results-form').addEventListener('submit', async function (event) {
		event.preventDefault();
		const ballotId = parseInt(document.getElementById('view-results-id-modal').value, 10);

		try {
			// Assuming there's a method in your contract to view results
			const results = await uVoteContract.methods.viewResults(ballotId).call();
			console.log('Results:', results);
			// Display results logic here
			$('#view-results-modal').modal('hide');
		} catch (error) {
			console.error('Error viewing results:', error);
		}
	});

	async function displayActiveVotes() {
		if (!uVoteContract) {
			console.log('Contract not initialized');
			return;
		}

		try {
			const nextBallotId = await uVoteContract.methods.nextBallotId().call();
			let activeVotes = [];

			for (let i = 0; i < nextBallotId; i++) {
				let isOpen = await uVoteContract.methods.isVotingOpen(i).call();
				if (isOpen) {
					activeVotes.push(i);
				}
			}

			renderVotes(activeVotes);
		} catch (error) {
			console.error('Error fetching active votes:', error);
		}
	}

	function renderVotes(voteList) {
		const votesContainer = document.getElementById('votes-container');
		votesContainer.innerHTML = '';

		voteList.forEach(vote => {
			const voteElement = document.createElement('div');
			voteElement.classList.add('vote-item');
			voteElement.innerText = `Vote ID: ${vote}`;
			votesContainer.appendChild(voteElement);
		});
	}
	async function tallyVotes(ballotId) {
		try {
			const transaction = await uVoteContract.methods.tallyVotes(ballotId).send({ from: walletAddress });
			console.log('Votes tallied successfully:', transaction);
		} catch (error) {
			console.error('Error tallying votes:', error);
		}
	}
	async function castVote(ballotId, selectedOptions) {
		try {
			const transaction = await uVoteContract.methods.castVote(ballotId, selectedOptions).send({ from: walletAddress });
			console.log('Vote cast successfully:', transaction);
		} catch (error) {
			console.error('Error casting vote:', error);
		}
	}
	async function checkIfVoted(ballotId, voterAddress) {
		try {
			const hasVoted = await uVoteContract.methods.hasVoted(ballotId, voterAddress).call();
			console.log(`Voter ${voterAddress} has voted in ballot ID ${ballotId}: ${hasVoted}`);
			return hasVoted;
		} catch (error) {
			console.error('Error checking if voted:', error);
		}
	}
	async function getOptionCount(ballotId, option) {
		try {
			const count = await uVoteContract.methods.getOptionCount(ballotId, option).call();
			console.log(`Count for option ${option} in ballot ID ${ballotId}: ${count}`);
			return count;
		} catch (error) {
			console.error('Error getting option count:', error);
		}
	}
	async function getMaxChoices(ballotId) {
		try {
			const maxChoices = await uVoteContract.methods.getMaxChoices(ballotId).call();
			console.log(`Maximum choices for ballot ID ${ballotId}: ${maxChoices}`);
			return maxChoices;
		} catch (error) {
			console.error('Error getting maximum choices:', error);
		}
	}
	async function checkIfVotingOpen(ballotId) {
		try {
			const isOpen = await uVoteContract.methods.isVotingOpen(ballotId).call();
			console.log(`Voting for ballot ID ${ballotId} is open: ${isOpen}`);
			return isOpen;
		} catch (error) {
			console.error('Error checking if voting is open:', error);
		}
	}
	async function sendDataToServer(optionsData, voteId) {
		// Log the inputs to the function
		console.log('Sending data to server...');
		console.log('Options Data:', optionsData);
		console.log('Vote ID:', voteId);

		try {
			const requestBody = JSON.stringify({ optionsData, voteId });
			// Log the request body
			console.log('Request Body:', requestBody);

			const response = await fetch('/submit_vote_options/', {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json',
					'X-CSRFToken': getCookie('csrftoken'),  // Ensure CSRF token is sent
				},
				body: requestBody
			});

			// Log the response status
			console.log('Response Status:', response.status);

			if (!response.ok) {
				throw new Error('Network response was not ok');
			}

			const data = await response.json();
			// Log the response data
			console.log('Response Data:', data);
		} catch (error) {
			// Log any errors that occur during the fetch
			console.error('Error during sendDataToServer:', error);
		}
	}


	// Helper function to get CSRF token
	function getCookie(name) {
		let cookieValue = null;
		if (document.cookie && document.cookie !== '') {
			const cookies = document.cookie.split(';');
			for (let i = 0; i < cookies.length; i++) {
				const cookie = cookies[i].trim();
				if (cookie.substring(0, name.length + 1) === (name + '=')) {
					cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
					break;
				}
			}
		}
		return cookieValue;
	}

</script>

{% endblock %}